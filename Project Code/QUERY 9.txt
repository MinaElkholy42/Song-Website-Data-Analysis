-- GET THE NUMBER OF SONGS PAID FOR EACH USER, FREE AND PERCENTAGE OF PAID INCOME FROM EACH USER

SELECT USER_ID, USER_FIRST_NAME, USER_LAST_NAME, PAID_SONGS_NUMBER, FREE_SONGS_NUMBER, 
CAST (PAID_SONGS_NUMBER AS FLOAT) / (PAID_SONGS_NUMBER + FREE_SONGS_NUMBER) PAID_SONGS_PERCENTAGE
FROM 
(
SELECT DISTINCT USER_ID, USER_FIRST_NAME, USER_LAST_NAME,
COUNT(CASE SONG_LEVEL WHEN 'paid' THEN 1 END) OVER(PARTITION BY USER_ID) PAID_SONGS_NUMBER, 
COUNT(CASE SONG_LEVEL WHEN 'free' THEN 1 END) OVER(PARTITION BY USER_ID) FREE_SONGS_NUMBER
FROM EVENTS
WHERE SONG_NAME IS NOT NULL AND SONG_PLAYED = 'NextSong') SUB_QUERY 
ORDER BY USER_ID;